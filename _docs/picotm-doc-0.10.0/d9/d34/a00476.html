<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>picotm: Transactional Lists</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">picotm
   &#160;<span id="projectnumber">0.10.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">Transactional Lists</div>  </div>
</div><!--header-->
<div class="contents">

<p>The transactional list provides a transaction-safe implementation of a double-linked list. Efficient insert and remove operations are supported anywhere within the list.  
<a href="#details">More...</a></p>
<div class="dynheader">
Collaboration diagram for Transactional Lists:</div>
<div class="dyncontent">
<center><table><tr><td><img src="../../d9/d34/a00476.png" border="0" alt="" usemap="#d9_2d34_2a00476"/>
<map name="d9_2d34_2a00476" id="d9_2d34_2a00476">
<area shape="rect" id="node2" href="../../d1/d92/a00475.html" title="The txlib module provides data structures that are safe to use from within transactions and cooperate..." alt="" coords="329,14,500,55"/>
</map>
</td></tr></table></center>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:db/ddc/a00353"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/ddc/a00353.html">picotm-txlist-state.h</a></td></tr>
<tr class="memdesc:db/ddc/a00353"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provides non-transactional state and entries for transactional lists. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d6/de1/a00356"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/de1/a00356.html">picotm-txlist.h</a></td></tr>
<tr class="memdesc:d6/de1/a00356"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provides transactional lists. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The <code>struct txlist</code> data structure represents a transactional double-linked list. To create a list, we first need list entries. These are represented by <code>struct <a class="el" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a></code>. We can add an instance of this data structure to any data value to turn it into a list entry. Here's an example for lists of values of type <code>unsigned long</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ulong_item {</div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a> list_entry;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">ulong_item_init(<span class="keyword">struct</span> ulong_item* item, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value)</div><div class="line">{</div><div class="line">    <a class="code" href="../../db/ddc/a00353.html#a6428df37b9dc92750e10b5a384fe6783" title="Initializes an entry of a transactional list. ">txlist_entry_init</a>(&amp;item-&gt;list_entry);</div><div class="line">    item-&gt;value = value;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct </span>ulong_item item;</div><div class="line"></div><div class="line">ulong_item_init(&amp;item, 0);</div></div><!-- fragment --><p>This code initializes the list entry using <code><a class="el" href="../../db/ddc/a00353.html#a6428df37b9dc92750e10b5a384fe6783" title="Initializes an entry of a transactional list. ">txlist_entry_init()</a></code>. The macro <code>TXLIST_ENTRY_INITIALIZER</code> initializes static or stack-allocated list entries. The example below illustrates this.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ulong_item {</div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a> list_entry;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> value;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#define ULONG_ITEM_INITIALIZER(_value)  \</span></div><div class="line"><span class="preprocessor">{                                       \</span></div><div class="line"><span class="preprocessor">    TXLIST_ENTRY_INITIALIZER,           \</span></div><div class="line"><span class="preprocessor">    (_value)                            \</span></div><div class="line"><span class="preprocessor">}</span></div><div class="line"></div><div class="line"><span class="keyword">struct </span>ulong_item item = ULONG_ITEM_INITIALIZER(0);</div></div><!-- fragment --><p>When both, macro and function initialization, is possible, the macro form is prefered. List entries are uninitialized with <code><a class="el" href="../../db/ddc/a00353.html#a93813d4970b8212216393ca2795457e3" title="Cleans up an entry of a transactional list. ">txlist_entry_uninit()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span></div><div class="line">ulong_item_uninit(<span class="keyword">struct</span> ulong_item* item)</div><div class="line">{</div><div class="line">    <a class="code" href="../../db/ddc/a00353.html#a93813d4970b8212216393ca2795457e3" title="Cleans up an entry of a transactional list. ">txlist_entry_uninit</a>(&amp;item-&gt;list_entry);</div><div class="line">}</div><div class="line"></div><div class="line">ulong_item_uninit(&amp;item);</div></div><!-- fragment --><p>To store the list entries, we need non-transactional list state, which represents the shared state of a double-linked list. It's implemented by <code>struct <a class="el" href="../../de/de6/a00723.html" title="The global state of transaction-safe list. ">txlist_state</a></code>. We can define and initialize a list state as illustrated in the example below.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../de/de6/a00723.html" title="The global state of transaction-safe list. ">txlist_state</a> list_state;</div><div class="line"></div><div class="line"><a class="code" href="../../db/ddc/a00353.html#ac0176640550edb7f680cf2d206a57fbb" title="Initializes list state. ">txlist_state_init</a>(&amp;list_state);</div></div><!-- fragment --><p>This code uses the initializer function <code><a class="el" href="../../db/ddc/a00353.html#ac0176640550edb7f680cf2d206a57fbb" title="Initializes list state. ">txlist_state_init()</a></code>. For static or stack-allocated list states, there's the initializer macro <code><a class="el" href="../../db/ddc/a00353.html#a697c945d82c5ea514867065bbc59f7a4" title="Initializer macro for struct txlist_state. ">TXLIST_STATE_INITIALIZER()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../de/de6/a00723.html" title="The global state of transaction-safe list. ">txlist_state</a> list_state = <a class="code" href="../../db/ddc/a00353.html#a697c945d82c5ea514867065bbc59f7a4" title="Initializer macro for struct txlist_state. ">TXLIST_STATE_INITIALIZER</a>(list_state);</div></div><!-- fragment --><p>When both forms are possible, the initializer macro is the prefered form.</p>
<p>List-state clean up is performed by <code><a class="el" href="../../db/ddc/a00353.html#a6a881a233f4eda74765e7aa6bedd421b" title="Cleans up list state. ">txlist_state_uninit()</a></code>. The list state may not contain entries when the clean-up happens. This means that entries have to be cleaned up from within a transaction.</p>
<p>For many uses this requirement just imposes unnecessary overhead. A call to <code><a class="el" href="../../db/ddc/a00353.html#a431628f7e1ec83df7f70921f0d356bdc" title="Removes all entries from a list state and runs a cleanup function on each. ">txlist_state_clear_and_uninit_entries()</a></code> provies a non-transactional way of clearing the list from its entries. It erases each element from the list and calls a clean-up function on it. The example below shows the clean-up code for a list of <code>struct ulong_item</code> entries.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ulong_item*</div><div class="line">ulong_item_of_entry(<span class="keyword">struct</span> <a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a>* entry)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="../../d2/de7/a00014.html#ac5d7110fe4aca39bb1fce3b46b2a1c3c">picotm_containerof</a>(entry, <span class="keyword">struct</span> ulong_item, list_entry);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span></div><div class="line">ulong_item_uninit_cb(<span class="keyword">struct</span> <a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a>* entry, <span class="keywordtype">void</span>* data)</div><div class="line">{</div><div class="line">    ulong_item_uninit(ulong_item_of_entry(entry));</div><div class="line"></div><div class="line">    <span class="comment">// call free() if item was malloc()&#39;ed</span></div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="../../db/ddc/a00353.html#a431628f7e1ec83df7f70921f0d356bdc" title="Removes all entries from a list state and runs a cleanup function on each. ">txlist_state_clear_and_uninit_entries</a>(&amp;list_state, ulong_item_uninit_cb, NULL);</div><div class="line"><a class="code" href="../../db/ddc/a00353.html#a6a881a233f4eda74765e7aa6bedd421b" title="Cleans up list state. ">txlist_state_uninit</a>(&amp;list_state);</div></div><!-- fragment --><p>At this point we have a list state and list entries to add to the state. So far all code was non-transactional. Actual list access and manipulation is performed by transactional code.</p>
<p>To perform list operations within a transaction, we first need a list data structure for our transaction. It's represented by <code>struct txlist</code>. A call to <code><a class="el" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx()</a></code> returns an instance.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Calling <code><a class="el" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx()</a></code> multiple times for the same list state <em>within the same transaction</em> returns the same list. Lists are undefined after their transaction committed or aborted, or within other, concurrent transactions.</p>
<p>With the list, we can now append or prepend entries to the list state using <code><a class="el" href="../../d6/de1/a00356.html#afcb11691957bca9b03646d17f2f4f1ef" title="Inserts an entry at the end of a transactional list. ">txlist_push_back_tx()</a></code> and <code><a class="el" href="../../d6/de1/a00356.html#acbbb6c5d78192080663c5abc3f280d20" title="Inserts an entry at the beginning of a transactional list. ">txlist_push_front_tx()</a></code>. The example below illustrates the use of <code><a class="el" href="../../d6/de1/a00356.html#afcb11691957bca9b03646d17f2f4f1ef" title="Inserts an entry at the end of a transactional list. ">txlist_push_back_tx()</a></code>.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#afcb11691957bca9b03646d17f2f4f1ef" title="Inserts an entry at the end of a transactional list. ">txlist_push_back_tx</a>(list, &amp;item-&gt;list_entry);</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>After this transaction committed, the ulong data item <code>item</code> will be the back-end entry in <code>list_state</code>. If the transactions has to abort after the call to <code><a class="el" href="../../d6/de1/a00356.html#afcb11691957bca9b03646d17f2f4f1ef" title="Inserts an entry at the end of a transactional list. ">txlist_push_back_tx()</a></code>, the transaction framework will automatically remove the appended entry during the rollback; thus restoring the original state.</p>
<p>To remove an entry from the list, we can call <code><a class="el" href="../../d6/de1/a00356.html#a137aa50a8f4a13e731d371abdd9b77dd" title="Removes an entry from a transactional list. ">txlist_erase_tx()</a></code>, as illustated in the example below.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <span class="comment">// The list state already contains the entry.</span></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#a137aa50a8f4a13e731d371abdd9b77dd" title="Removes an entry from a transactional list. ">txlist_erase_tx</a>(list, &amp;item-&gt;list_entry);</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>As usual, all errors are detected and handled by the transaction framework. The benefits of transactional code show when we move entries between lists.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* src_list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;src_list_state);</div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* dst_list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;dst_list_state);</div><div class="line"></div><div class="line">    <span class="comment">// The list state already contains the entry.</span></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#a137aa50a8f4a13e731d371abdd9b77dd" title="Removes an entry from a transactional list. ">txlist_erase_tx</a>(src_list, &amp;item-&gt;list_entry);</div><div class="line"></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#afcb11691957bca9b03646d17f2f4f1ef" title="Inserts an entry at the end of a transactional list. ">txlist_push_back_tx</a>(dst_list, &amp;item-&gt;list_entry);</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>In this example, we remove an entry from a source list and append it to a destination list. The transaction framework automatically isolates these operations from concurrent transactions until the transaction commits. So concurrent transactions see the entry in <em>either</em> the source list <em>or</em> the destination list, but never in both. If the transaction has to roll back after the append operation, the transaction framework automatically removes the list entry from the destination list and returns it to its old position in the source list.</p>
<p>A call to <code><a class="el" href="../../d6/de1/a00356.html#afd1ba98b3bb47cce963b3325739e758d" title="Returns the number of entries in a transactional list. ">txlist_size_tx()</a></code> returns the number of list entries, a call to <code><a class="el" href="../../d6/de1/a00356.html#acfb00d621b95228f305accecb40c4416" title="Tests a transactional list for emptiness. ">txlist_empty_tx()</a></code> returns <code>true</code> if a list is empty. The former function might have linear complexity, the later function always has constant complexity. It's therefore better to use <code><a class="el" href="../../d6/de1/a00356.html#acfb00d621b95228f305accecb40c4416" title="Tests a transactional list for emptiness. ">txlist_empty_tx()</a></code> if it's only relevant whether there are entries.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> is_empty = <a class="code" href="../../d6/de1/a00356.html#acfb00d621b95228f305accecb40c4416" title="Tests a transactional list for emptiness. ">txlist_empty_tx</a>(list);</div><div class="line"></div><div class="line">    <span class="keywordtype">size_t</span> size = <a class="code" href="../../d6/de1/a00356.html#afd1ba98b3bb47cce963b3325739e758d" title="Returns the number of entries in a transactional list. ">txlist_size_tx</a>(list);</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>If we known that their are entries in the list, calls to <code><a class="el" href="../../d6/de1/a00356.html#aa15d2c9b9b8d862260d144be2b28c1a3" title="Returns the front-end entry of a transactional list without removing it. ">txlist_front_tx()</a></code> and <code><a class="el" href="../../d6/de1/a00356.html#aafda05b9d13ac3f0ab4ca6805716b0ce" title="Returns the back-end entry of a transactional list without removing it. ">txlist_back_tx()</a></code> return the front-end, resp. the back-end entry.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="../../d6/de1/a00356.html#acfb00d621b95228f305accecb40c4416" title="Tests a transactional list for emptiness. ">txlist_empty_tx</a>(tx)) {</div><div class="line"></div><div class="line">        <span class="keyword">struct </span><a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a>* entry = <a class="code" href="../../d6/de1/a00356.html#aa15d2c9b9b8d862260d144be2b28c1a3" title="Returns the front-end entry of a transactional list without removing it. ">txlist_front_tx</a>()</div><div class="line"></div><div class="line">        <span class="comment">// more transactional code</span></div><div class="line">    }</div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>We can also iterate over the entries of a list. The first entry of the list is returned by <code><a class="el" href="../../d6/de1/a00356.html#a042d513bb968743a3006a62966683785" title="Returns the first entry of a transactional list. ">txlist_begin_tx()</a></code>. The terminator entry <em>after</em> the final entry is returned by <code><a class="el" href="../../d6/de1/a00356.html#a491aa0776a3263a20b303a7c1ef65cb9" title="Returns the terminator of a transactional list. ">txlist_end_tx()</a></code>. The terminator entry is not a real entry and should not be dereferenced. Calls to <code><a class="el" href="../../db/ddc/a00353.html#a85ce17fb11552fcfc4679fb2c6398d88" title="Returns the next list entry. ">txlist_entry_next_tx()</a></code> and <code><a class="el" href="../../db/ddc/a00353.html#a4e77b75010e87be2764f5903b1701ec6" title="Returns the previous list entry. ">txlist_entry_prev_tx()</a></code> return an entry's successor or predecessor. Here's and example that iterates over a list of values of type <code>unsigned long</code> and sums up the individual values.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> g_sum; <span class="comment">// global variable containg sum of list entries</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sum = 0;</div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a>* beg = <a class="code" href="../../d6/de1/a00356.html#a042d513bb968743a3006a62966683785" title="Returns the first entry of a transactional list. ">txlist_begin_tx</a>(list);</div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../d3/d3b/a00715.html" title="Represents an entry in a transaction-safe list. ">txlist_entry</a>* end = <a class="code" href="../../d6/de1/a00356.html#a491aa0776a3263a20b303a7c1ef65cb9" title="Returns the terminator of a transactional list. ">txlist_end_tx</a>(list);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (beg != end) {</div><div class="line"></div><div class="line">        <span class="keyword">struct </span>ulong_item* item = ulong_item_of_entry(beg);</div><div class="line"></div><div class="line">        sum += item-&gt;value;</div><div class="line"></div><div class="line">        beg = <a class="code" href="../../db/ddc/a00353.html#a85ce17fb11552fcfc4679fb2c6398d88" title="Returns the next list entry. ">txlist_entry_next_tx</a>(beg);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line">    <span class="comment">// Picotm&#39;s modules collaborate! The value stored in</span></div><div class="line">    <span class="comment">// `sum` is exported from the transaction state using</span></div><div class="line">    <span class="comment">// `store_ulong_tx()` from the Transactional Memory</span></div><div class="line">    <span class="comment">// module.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../de/d55/a00323.html#ac001d9940eb6479334b1e2b9d8eb65f4">store_ulong_tx</a>(&amp;g_sum, sum);</div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>If we have an entry in a list, we can insert another entry <em>before</em> the existing one with <code><a class="el" href="../../d6/de1/a00356.html#a136d9011a0b390ad47373b8a6351bba2" title="Inserts an entry into a transactional list. ">txlist_insert_tx()</a></code>. In the example below, we insert before the terminator entry, which is equivalent to an append operation.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#a136d9011a0b390ad47373b8a6351bba2" title="Inserts an entry into a transactional list. ">txlist_insert_tx</a>(list, &amp;item-&gt;list_entry, <a class="code" href="../../d6/de1/a00356.html#a491aa0776a3263a20b303a7c1ef65cb9" title="Returns the terminator of a transactional list. ">txlist_end_tx</a>(list));</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>To append or prepend entries to a list, it's better use the appropriate push functions, though. The transaction framework might be able to optimize concurrency control for each. Also, inserting or removing from a list can make iteration loops invalid. It's therefore better to separate these operations cleanly.</p>
<p>Finally, to clear the whole list at once, there's <code><a class="el" href="../../d6/de1/a00356.html#a7acb938cbbb18810c6f1b302a0d05bd8" title="Removes all entries from a transactional list. ">txlist_clear_tx()</a></code>. It's equivalent to a continuous erase operation, but prefered for its reduced overhead.</p>
<div class="fragment"><div class="line"><span class="comment">// init and ulong code here</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keyword">struct </span><a class="code" href="../../de/dfc/a00891.html" title="A handle for operating on transaction-safe lists. ">txlist</a>* list = <a class="code" href="../../d6/de1/a00356.html#af4e51e648833fef875918e74c91b90ae" title="Creates a transactional list for a list state. ">txlist_of_state_tx</a>(&amp;list_state);</div><div class="line"></div><div class="line">    <a class="code" href="../../d6/de1/a00356.html#a7acb938cbbb18810c6f1b302a0d05bd8" title="Removes all entries from a transactional list. ">txlist_clear_tx</a>(list);</div><div class="line"></div><div class="line">    <span class="comment">// more transactional code</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/d12/a00911.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
