<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>picotm: The Transactional Memory Module</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">picotm
   &#160;<span id="projectnumber">0.9.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">The Transactional Memory Module</div>  </div>
</div><!--header-->
<div class="contents">

<p>The Transactional Memory module provides transactional semantics when accessing main memory. You can load and store variables in main memory, or adopt memory regions into a transactions.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:d5/d0f/a00308"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d0f/a00308.html">picotm-tm.h</a></td></tr>
<tr class="memdesc:d5/d0f/a00308"><td class="mdescLeft">&#160;</td><td class="mdescRight">Public interfaces of picotm's Transactional Memory module. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The Transactional Memory module provides load and store operations for main memory. In order to avoid conflicting access to shared memory locations, picotm has to know which transaction uses which location. The Transactional Memory module maintains these information.</p>
<p>Call <a class="el" href="../../d5/d0f/a00308.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx()</a> to load a memory location into your transaction.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx;</div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx</a>(&amp;x, &amp;x_tx, <span class="keyword">sizeof</span>(x));</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x&#39; is now stored in &#39;x_tx&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>This copies the value of 'x' into your transaction's variable 'x_tx' and puts the memory location of 'x' under control of the transaction manager. You're free to change the value of 'x_tx' at will, since it's transaction local. If you change it, the original, non-transactional value in 'x' remains unchanged.</p>
<p>Similarly, you can store a copy of a transactional variable in a memory location. This is done with <a class="el" href="../../d5/d0f/a00308.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx()</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx;</div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx</a>(&amp;x, &amp;x_tx, <span class="keyword">sizeof</span>(x));</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_tx&#39; will be committed into &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>As with all transactional modifications, the store will not be executed immediately, but only become permanent after the transaction successfully committed.</p>
<p>You don't have to deal with all these addresses yourself. The TM module comes with helper functions for various basic C types are provided. With <code><a class="el" href="../../d5/d0f/a00308.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx()</a></code> and <code><a class="el" href="../../d5/d0f/a00308.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx()</a></code> we can rewrite the example transactions as shown below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx = <a class="code" href="../../d5/d0f/a00308.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx</a>(&amp;x);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x&#39; is now stored in &#39;x_tx&#39;.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx</a>(&amp;x, x_tx);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_tx&#39; will be committed into &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Besides <code><a class="el" href="../../d5/d0f/a00308.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx()</a></code> and <code><a class="el" href="../../d5/d0f/a00308.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx()</a></code>, the Transactional Memory module provides similar functions for the basic C types. Each is defined via the macros <a class="el" href="../../d5/d0f/a00308.html#a5efe8b5eade6b9a12c00ba9a39a48f91">PICOTM_TM_LOAD_TX()</a> and <a class="el" href="../../d5/d0f/a00308.html#a99cf85592e12bc32b930e594df346ef1">PICOTM_TM_STORE_TX()</a>. You can use these macros to define load and store functions for your application's data types. Both macros expand to inline C functions, so you don't loose performance compared to <a class="el" href="../../d5/d0f/a00308.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx()</a> and <a class="el" href="../../d5/d0f/a00308.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx()</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// An application-specific type</span></div><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    my_int_type;</div><div class="line"></div><div class="line"><span class="comment">// Define load_my_int_type_tx()</span></div><div class="line"><a class="code" href="../../d5/d0f/a00308.html#a5efe8b5eade6b9a12c00ba9a39a48f91">PICOTM_TM_LOAD_TX</a>(my_int_type, my_int_type);</div><div class="line"></div><div class="line"><span class="comment">// Define store_my_int_type_tx()</span></div><div class="line"><a class="code" href="../../d5/d0f/a00308.html#a99cf85592e12bc32b930e594df346ef1">PICOTM_TM_STORE_TX</a>(my_int_type, my_int_type);</div></div><!-- fragment --><p>Since address and pointer handling can be tricky, there are also helpers for loading and storing pointers. Note that these functions load and store the address stored in a pointer variable, but not the value stored at that address.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* x_ptr;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span>* x_ptr_tx = <a class="code" href="../../d5/d0f/a00308.html#ab4380a1a8d73b3b562757425e7ab9094">load_ptr_tx</a>(&amp;x_ptr);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_ptr&#39; is now stored in &#39;x_ptr_tx&#39;.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#a39ce6fb681ffc001e2346c3fb3f421d9">store_ptr_tx</a>(&amp;x_ptr, &amp;x_ptr_tx);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_ptr_tx&#39; will be committed into &#39;x_ptr&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Loads and stores always copy values into or out of a transaction. There are cases where you don't want a copy, but the exact memory location of a value. This is called <em>privatization</em>. For example, the function <code>memcpy()</code> loads and stores an indefinite amount of data between memory buffers. The actual buffer size is often not known in advance. It would be wasteful to first load the data into a transaction-local buffer and then further store it in another buffer.</p>
<p>The functions <a class="el" href="../../d5/d0f/a00308.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx()</a> and <a class="el" href="../../d5/d0f/a00308.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a> offer privatization of memory locations.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx</a>(&amp;x, <span class="keyword">sizeof</span>(x), <a class="code" href="../../d5/d0f/a00308.html#a99fb83031ce9923c84392b4e92f956b5ab2fc72e61777f33a35b73fbe4431bb41">PICOTM_TM_PRIVATIZE_LOAD</a>);</div><div class="line"></div><div class="line">    <span class="comment">// The memory location of &#39;x&#39; is now available within the transaction.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx</a>(&amp;x, <span class="keyword">sizeof</span>(x), <a class="code" href="../../d5/d0f/a00308.html#a99fb83031ce9923c84392b4e92f956b5a182a1cba2a7e3b183054a15dd36ded9f">PICOTM_TM_PRIVATIZE_STORE</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Changes to &#39;x&#39; will be committed into the memory location of &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>This privatizes 'x' for transactional access from within the transaction. The number of bytes is given in the second argument. The flags argument is a bitmask of PICOTM_TM_PRIVATIZE_LOAD and PICOTM_TM_PRIVATIZE_STORE. These flags control how picotm handles the memory location. If you only privatized a memory location for loading <em>or</em> storing, you should execute the other operation.</p>
<p>There can be cases where you don't know in advance how long the privatized buffer is going to be. For example, when you privatize a C string, the length is not always given, but given by the location of the terminating <code>\0</code> character. To privatize a memory region up to and including a specific character, use <a class="el" href="../../d5/d0f/a00308.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span>* str = <span class="stringliteral">&quot;foo&quot;</span>;</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx</a>(str, <span class="charliteral">&#39;\0&#39;</span>, <a class="code" href="../../d5/d0f/a00308.html#a99fb83031ce9923c84392b4e92f956b5ab2fc72e61777f33a35b73fbe4431bb41">PICOTM_TM_PRIVATIZE_LOAD</a>);</div><div class="line"></div><div class="line">    <span class="comment">// The string in &#39;str&#39; is now available within the transaction.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx</a>(str, <span class="charliteral">&#39;0&#39;</span>, <a class="code" href="../../d5/d0f/a00308.html#a99fb83031ce9923c84392b4e92f956b5a182a1cba2a7e3b183054a15dd36ded9f">PICOTM_TM_PRIVATIZE_STORE</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Changes to &#39;str&#39; will be committed into the string of &#39;str&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Using <a class="el" href="../../d5/d0f/a00308.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a> with strings is the most common use case, but arbitrary characters are possible.</p>
<p>Finally, there is <a class="el" href="../../d5/d0f/a00308.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx()</a>. Even through the name suggests load-and-store, the function is a mixture of load, store and privatization. It privatizes an input buffer for loading and an output buffer for storing, and copies the input buffer's content into the output buffer.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ibuf[20];</div><div class="line"><span class="keywordtype">int</span> obuf[20];</div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../d5/d0f/a00308.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx</a>(ibuf, obuf, <span class="keyword">sizeof</span>(obuf));</div><div class="line"></div><div class="line">    <span class="comment">// The data in &#39;ibuf&#39; will be committed into the memory of &#39;obuf&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d9/d22/a00873.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>A call to <a class="el" href="../../d5/d0f/a00308.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx()</a> is like a call to <code>memcpy()</code> that privatizes its input buffers. It's an optimization for platform without transactional C library. </p>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
