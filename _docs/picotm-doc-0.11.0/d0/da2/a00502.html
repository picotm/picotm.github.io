<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>picotm: The Arithmetic Module</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">The Arithmetic Module</div>  </div>
</div><!--header-->
<div class="contents">

<p>The arithmetic module provides safe arithmetics for C types. Overflows or underflows in the type's range are reported as errors to the transaction.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:df/d91/a00335"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../df/d91/a00335.html">picotm-arithmetic-ctypes.h</a></td></tr>
<tr class="memdesc:df/d91/a00335"><td class="mdescLeft">&#160;</td><td class="mdescRight">Transactional, safe arithmetics for native C types. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:dc/d84/a00338"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d84/a00338.html">picotm-arithmetic.h</a></td></tr>
<tr class="memdesc:dc/d84/a00338"><td class="mdescLeft">&#160;</td><td class="mdescRight">Public interfaces of picotm's arithmetic module. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The arithmetic module provides safe arithmetic operations for C types. Overflows, underflows and undefined operations are detected and reported to the transaction's recovery code. Supported operations are additions, subtractions, multiplications and divisions.</p>
<p>Additions are in the form <code>add_&lt;type&gt;_tx()</code> where <code>&lt;type&gt;</code> is the name of the C type. For example, overflow-safe addition of two long integer values is performed by the following transaction.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line">    <span class="keywordtype">long</span> res = <a class="code" href="../../df/d91/a00335.html#a1b24973c70af78bce574a4e0235e77fa">add_long_tx</a>(INT_MAX, INT_MAX);</div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="../../d4/dee/a00008.html#a7793e31c9b070a4be6f5747c5b43342e">picotm_error_status</a>() == <a class="code" href="../../d4/dee/a00008.html#a7793e31c9b070a4be6f5747c5b43342ea2845cde18d3b63d65fe77fc9f847eb84">PICOTM_ERRNO</a>) &amp;&amp;</div><div class="line">        (<a class="code" href="../../d7/db6/a00940.html#a997121ceed6277b7ef69dbad1aa68086">picotm_error_as_errno</a>() == ERANGE)) {</div><div class="line">        <span class="comment">// An error happened during an arithmetic operation.</span></div><div class="line">    }</div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>The success of this operations depends on the size of type <code>long</code>. If <code>long</code> is 64 bit in size, the addition will return the sum of both operands. If <code>long</code> is only 32 bit in size, which is the same of <code>int</code> on most platforms, the addition will overflow and the function will roll the transaction back to the previous consistent state and report <code>ERANGE</code> to the recovery code.</p>
<p>The arithmetic module comes with support for all native C types. We can define safe addition for application-specific types with the C preprocessor macros <code><a class="el" href="../../dc/d84/a00338.html#a12a9a2c2e26d0b29e200d2613f1094d1">PICOTM_ARITHMETIC_ADD_S_TX()</a></code>, <code><a class="el" href="../../dc/d84/a00338.html#a2a5f6c86902d2e35b94f00c26af91983">PICOTM_ARITHMETIC_ADD_U_TX()</a></code> and <code><a class="el" href="../../dc/d84/a00338.html#a052a8d4faef46c8438301e988ff754ed">PICOTM_ARITHMETIC_ADD_F_TX()</a></code>. The first macro, <code><a class="el" href="../../dc/d84/a00338.html#a12a9a2c2e26d0b29e200d2613f1094d1">PICOTM_ARITHMETIC_ADD_S_TX()</a></code> supports signed integer types; the second macro, <code><a class="el" href="../../dc/d84/a00338.html#a2a5f6c86902d2e35b94f00c26af91983">PICOTM_ARITHMETIC_ADD_U_TX()</a></code>, supports unsigned integer types. Finally, the third macro, <code><a class="el" href="../../dc/d84/a00338.html#a052a8d4faef46c8438301e988ff754ed">PICOTM_ARITHMETIC_ADD_F_TX()</a></code>, supports floating-point types.</p>
<p>For example, an application might use the specialized floating-point type <code>float100</code>, which only contains values from minus 100 to plus 100.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">float</span> float100;</div><div class="line"></div><div class="line"><span class="preprocessor">#define FLT100_MAX  100     // similar to FLT_MAX from &lt;float.h&gt;</span></div></div><!-- fragment --><p>We can use the macro <code><a class="el" href="../../dc/d84/a00338.html#a052a8d4faef46c8438301e988ff754ed">PICOTM_ARITHMETIC_ADD_F_TX()</a></code> to create an add function that overflows at plus 100 and underflows at minus 100.</p>
<div class="fragment"><div class="line">float100</div><div class="line">float100_add(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs + rhs;</div><div class="line">}</div><div class="line"></div><div class="line">float100</div><div class="line">float100_sub(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs - rhs;</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="../../dc/d84/a00338.html#a052a8d4faef46c8438301e988ff754ed">PICOTM_ARITHMETIC_ADD_F_TX</a>(float100, float100, FLT100_MAX, 0.f,</div><div class="line">                         float100_add, float_100_sub)</div></div><!-- fragment --><p>The first two parameters are name and C type of the function. The third parameter is the type's range or extension. For <code>float100</code> it ranges from <code>-FLT100_MAX</code> to <code>FLT100_MAX</code>. The forth paramater is the value of the type's operation's identity element (i.e., the value that does nothing for the operation). For additions, the identity element is <em>0.</em> The two final macro parameters are the type's primitive addition and subtraction functions. These functions perform the plain operations without safety checks.</p>
<p>The example macro invocation expands to the following function.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span></div><div class="line">float100</div><div class="line">add_float100_tx(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    ... <span class="comment">// safe addition</span></div><div class="line">}</div></div><!-- fragment --><p>A transaction can use it like <code><a class="el" href="../../df/d91/a00335.html#a1b24973c70af78bce574a4e0235e77fa">add_long_tx()</a></code> in the previous example.</p>
<div class="fragment"><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line">    float100 res = add_float100_tx(75.f, 25.f);</div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="../../d4/dee/a00008.html#a7793e31c9b070a4be6f5747c5b43342e">picotm_error_status</a>() == <a class="code" href="../../d4/dee/a00008.html#a7793e31c9b070a4be6f5747c5b43342ea2845cde18d3b63d65fe77fc9f847eb84">PICOTM_ERRNO</a>) &amp;&amp;</div><div class="line">        (<a class="code" href="../../d7/db6/a00940.html#a997121ceed6277b7ef69dbad1aa68086">picotm_error_as_errno</a>() == ERANGE)) {</div><div class="line">        <span class="comment">// An error happened during an arithmetic operation.</span></div><div class="line">    }</div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Picotm provides equivalent generator macros for subtraction, multiplication and division of signed integer types, unsigned integer types and floating-point types. Defining subtraction, multiplication and division completes elementary arithmetics for <code>float100</code>. The full example code is shown below.</p>
<div class="fragment"><div class="line">float100</div><div class="line">float100_add(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs + rhs;</div><div class="line">}</div><div class="line"></div><div class="line">float100</div><div class="line">float100_sub(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs - rhs;</div><div class="line">}</div><div class="line"></div><div class="line">float100</div><div class="line">float100_mul(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs * rhs;</div><div class="line">}</div><div class="line"></div><div class="line">float100</div><div class="line">float100_div(float100 lhs, float100 rhs)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> lhs / rhs;</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="../../dc/d84/a00338.html#a052a8d4faef46c8438301e988ff754ed">PICOTM_ARITHMETIC_ADD_F_TX</a>(float100, float100, FLT100_MAX, 0.f,</div><div class="line">                         float100_add, float_100_sub)</div><div class="line"><a class="code" href="../../dc/d84/a00338.html#a3cc53d30fe6927d2d7cd9945dfbe0c04">PICOTM_ARITHMETIC_SUB_F_TX</a>(float100, float100, FLT100_MAX, 0.f,</div><div class="line">                         float100_add, float_100_sub)</div><div class="line"><a class="code" href="../../dc/d84/a00338.html#a3c472ac9c3550c87e8566e375ad6e725">PICOTM_ARITHMETIC_MUL_F_TX</a>(float100, float100, FLT100_MAX, 1.f, 0.f,</div><div class="line">                         float100_mul, float_100_div)</div><div class="line"><a class="code" href="../../dc/d84/a00338.html#a90390e84a78ca467deb3404c9ad52d1d">PICOTM_ARITHMETIC_DIV_F_TX</a>(float100, float100, FLT100_MAX, 1.f, 0.f,</div><div class="line">                         float100_div, float_100_div)</div></div><!-- fragment --><p>The identity element for multiplication and division is <em>1.</em> In addition to the identity element, the generator macros for multiplication and division take an additional absorbing element. This is the value the maps each factor to the absorbing element itself. For multiplication this value is <em>0.</em> For divisions by the absorbing element, the generated division function rolls the transaction back and returns the errno code <code>EDOM</code> to the recovery mode.</p>
<p>Results or parameters of arithmetics operations should be loaded into the transaction or stored from the transaction using the Transactional Memory module. </p>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<!--
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
-->
</body>
</html>
