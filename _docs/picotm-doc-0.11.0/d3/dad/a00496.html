<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>picotm: The Module Interface</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">The Module Interface</div>  </div>
</div><!--header-->
<div class="contents">

<p>Picotm is extensible. This section explains the module interface and how to implement your own module on top.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:dd/dad/a00005"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/dad/a00005.html">compiler.h</a></td></tr>
<tr class="memdesc:dd/dad/a00005"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains macros for dealing with compiler extensions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d4/dee/a00008"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/dee/a00008.html">picotm-error.h</a></td></tr>
<tr class="memdesc:d4/dee/a00008"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains struct <a class="el" href="../../d4/dfb/a00512.html">picotm_error</a> and helper functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:da/d45/a00011"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/d45/a00011.html">picotm-lib-array.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d2/de7/a00014"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d2/de7/a00014.html">picotm-lib-ptr.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d4/d51/a00017"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d51/a00017.html">picotm-lib-ref.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d0/df0/a00934"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d0/df0/a00934.html">picotm-lib-rwlock.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d3/d52/a00023"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d3/d52/a00023.html">picotm-lib-rwstate.h</a></td></tr>
<tr class="memdesc:d3/d52/a00023"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains <code>struct <a class="el" href="../../d7/d41/a00532.html">picotm_rwstate</a></code> and helpers. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d6/d5b/a00026"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d6/d5b/a00026.html">picotm-lib-shared-ref-obj.h</a></td></tr>
<tr class="memdesc:d6/d5b/a00026"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains <code>struct picotm_shared_ref16_obj</code> and helper functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d5/d16/a00029"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d5/d16/a00029.html">picotm-lib-shared-treemap.h</a></td></tr>
<tr class="memdesc:d5/d16/a00029"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains <code>struct <a class="el" href="../../d4/d79/a00540.html" title="Maps keys to values. ">picotm_shared_treemap</a></code> and helper functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:dc/d87/a00032"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dc/d87/a00032.html">picotm-lib-spinlock.h</a></td></tr>
<tr class="memdesc:dc/d87/a00032"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains <code>struct <a class="el" href="../../d2/ddf/a00544.html" title="Provides an operating-system-neutral, non-recursive spin-lock type. ">picotm_spinlock</a></code> and helper functions. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d4/d8c/a00035"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d8c/a00035.html">picotm-lib-tab.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:d8/d41/a00038"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d8/d41/a00038.html">picotm-lib-treemap.h</a></td></tr>
<tr class="memdesc:d8/d41/a00038"><td class="mdescLeft">&#160;</td><td class="mdescRight">Contains <code>struct <a class="el" href="../../dd/de6/a00548.html" title="Maps keys to values. ">picotm_treemap</a></code> and helpers. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:dd/d32/a00041"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d32/a00041.html">picotm-module.h</a></td></tr>
<tr class="memdesc:dd/d32/a00041"><td class="mdescLeft">&#160;</td><td class="mdescRight">Picotm's module interface. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Picotm is only a transaction manager. It maintains transactions but doesn't provide their functionality. All actual transactional operations are provided by additional modules. Picotm can be extended with arbitrary functionality. The interface is available to external libraries, so no modification to picotm is required.</p>
<h1>Registering Your Module</h1>
<p>To register a module, call <a class="el" href="../../dd/d32/a00041.html#a3c0a82c58e3ebca68625099573038a88">picotm_register_module()</a>. The call receives a number of module-specific call-back functions and module data, and returns a unique module number. The call-back functions are invoked by picotm to instruct the module during different phases of a transaction. The returned module number is later required when inserting events into the transaction log.</p>
<p>For an example, let's look at a transactional allocator. Registering the module might look like this.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="../../d4/dfb/a00512.html">picotm_error</a> error = PICOTM_ERROR_INITIALIZER;</div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> module_number =</div><div class="line">    <a class="code" href="../../dd/d32/a00041.html#a3c0a82c58e3ebca68625099573038a88">picotm_register_module</a>(NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           apply, <span class="comment">// See below.</span></div><div class="line">                           undo,  <span class="comment">// See below.</span></div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           NULL,</div><div class="line">                           &amp;error);</div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="../../d4/dee/a00008.html#a2b55a07e710ba43ea793a67e5e817b08">picotm_error_is_set</a>(&amp;error)) {</div><div class="line">    <span class="comment">// abort with an error</span></div><div class="line">}</div></div><!-- fragment --><p>Modules are registered per-thread. You have to register your module on each thread where it is used.</p>
<h1>Injecting Events into the Transaction Log.</h1>
<p>When the user invokes an operation of your module, the module might wants to store an event in the transaction log. This is done by invoking picotm_inject_event(). During the transaction's commit, events in the transaction log are applied in the order they appear in the log. During a roll-back, events are reverted in opposite order.</p>
<p>In the case of our transactional allocator, we have two functions, <code>malloc()</code> and <code>free()</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">enum</span> {</div><div class="line">    CMD_MALLOC,</div><div class="line">    CMD_FREE</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// Public interface called from with transaction.</span></div><div class="line"><span class="keywordtype">void</span>*</div><div class="line"><a class="code" href="../../d9/d77/a00095.html#aa6bbef363f8a6ea258266d490f7a3946">malloc_tx</a>(<span class="keywordtype">size_t</span> siz)</div><div class="line">{</div><div class="line">    <span class="keywordtype">void</span>* ptr = malloc(siz);</div><div class="line">    <span class="keywordflow">if</span> (!ptr) {</div><div class="line">        <span class="comment">// In real-world code, do error handling here!</span></div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">int</span> res = picotm_inject_event(module_number, CMD_MALLOC, ptr);</div><div class="line">    <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">        <span class="comment">// In real-world code, do error handling here!</span></div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> ptr;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// Public interface called from with transaction.</span></div><div class="line"><span class="keywordtype">void</span></div><div class="line"><a class="code" href="../../d9/d77/a00095.html#a7748f6b2640129f7a51008744ce7536f">free_tx</a>(<span class="keywordtype">void</span>* ptr)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> res = picotm_inject_event(module_number, CMD_FREE, ptr);</div><div class="line">    <span class="keywordflow">if</span> (res &lt; 0) {</div><div class="line">        <span class="comment">// In real-world code, do error handling here!</span></div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> ptr;</div><div class="line">}</div></div><!-- fragment --><h1>Applying and Reverting Events</h1>
<p>For applying or reverting events, your module must provide the respective callbacks to <a class="el" href="../../dd/d32/a00041.html#a3c0a82c58e3ebca68625099573038a88">picotm_register_module()</a>. These are invoked by picotm during the life time of a transaction.</p>
<p>For our example of the transactional allocator, these call-back functions will look like this.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span></div><div class="line">apply(uint16_t head, uintptr_t tail, <span class="keywordtype">void</span>* data, <span class="keyword">struct</span> <a class="code" href="../../d4/dfb/a00512.html">picotm_error</a>* error)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (head == CMD_MALLOC) {</div><div class="line">        <span class="comment">// Nothing to do.</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (head == CMD_FREE) {</div><div class="line">        <span class="comment">// Apply free().</span></div><div class="line">        free((<span class="keywordtype">void</span>*)tail);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span></div><div class="line">undo(uint16_t head, uintptr_t tail, <span class="keywordtype">void</span>* data, <span class="keyword">struct</span> <a class="code" href="../../d4/dfb/a00512.html">picotm_error</a>* error)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (head == CMD_MALLOC) {</div><div class="line">        <span class="comment">// Revert malloc().</span></div><div class="line">        free((<span class="keywordtype">void</span>*)tail);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (head == CMD_FREE) {</div><div class="line">        <span class="comment">// Nothing to do.</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>In our example we have registered a module for a transactional allocator. The malloc operation allocates memory, but reverts this allocation during an undo. The free operation doesn't actually free the memory immediately, but creates an event to free the memory during a commit. </p>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<!--
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
-->
</body>
</html>
