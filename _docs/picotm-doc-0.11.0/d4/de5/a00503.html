<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>picotm: The Transactional Memory Module</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">The Transactional Memory Module</div>  </div>
</div><!--header-->
<div class="contents">

<p>The Transactional Memory module provides transactional semantics when accessing main memory. You can load and store variables in main memory, or adopt memory regions into a transactions.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:d1/dc6/a00347"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dc6/a00347.html">picotm-tm-ctypes.h</a></td></tr>
<tr class="memdesc:d1/dc6/a00347"><td class="mdescLeft">&#160;</td><td class="mdescRight">Provides Transactional Memory operations for native C types. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:db/d10/a00350"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/d10/a00350.html">picotm-tm.h</a></td></tr>
<tr class="memdesc:db/d10/a00350"><td class="mdescLeft">&#160;</td><td class="mdescRight">Public interfaces of picotm's Transactional Memory module. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>The Transactional Memory module provides load and store operations for main memory. In order to avoid conflicting access to shared memory locations, picotm has to know which transaction uses which locations. The Transactional Memory module maintains these information.</p>
<p>A call to <code><a class="el" href="../../db/d10/a00350.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx()</a></code> copies a memory location's value into a transaction, as illustrated in the example below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx;</div><div class="line">    <a class="code" href="../../db/d10/a00350.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx</a>(&amp;x, &amp;x_tx, <span class="keyword">sizeof</span>(x));</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x&#39; is now stored in &#39;x_tx&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>This copies the value of <code>x</code> into our transaction's variable <code>x_tx</code> and puts the memory location of <code>x</code> under control of the transaction manager. We are free to change the value of <code>x_tx</code> at will, since it's transaction local. If we change it, the original non-transactional value in <code>x</code> remains unchanged.</p>
<p>In a similarly way we store a copy of a transactional variable in a memory location. This is done with <code><a class="el" href="../../db/d10/a00350.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx;</div><div class="line">    <a class="code" href="../../db/d10/a00350.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx</a>(&amp;x, &amp;x_tx, <span class="keyword">sizeof</span>(x));</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_tx&#39; will be committed into &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>As with all transactional modifications, the store will not be executed immediately, but only become permanent after the transaction successfully committed.</p>
<p>We don't have to deal with all these addresses ourselves. The TM module comes with helper functions for the basic C types. With <code><a class="el" href="../../d1/dc6/a00347.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx()</a></code> and <code><a class="el" href="../../d1/dc6/a00347.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx()</a></code> we can rewrite the example transactions as shown below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> x_tx = <a class="code" href="../../d1/dc6/a00347.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx</a>(&amp;x);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x&#39; is now stored in &#39;x_tx&#39;.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../d1/dc6/a00347.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx</a>(&amp;x, x_tx);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_tx&#39; will be committed into &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Besides <code><a class="el" href="../../d1/dc6/a00347.html#a4f942c7d9ada982dc837e5bbc2c90092">load_int_tx()</a></code> and <code><a class="el" href="../../d1/dc6/a00347.html#a8d77c31d58d6abecee1aaeb50921b531">store_int_tx()</a></code>, the Transactional Memory module provides similar functions for the basic C types. Each is defined via the macros <code><a class="el" href="../../db/d10/a00350.html#a5efe8b5eade6b9a12c00ba9a39a48f91">PICOTM_TM_LOAD_TX()</a></code> and <code><a class="el" href="../../db/d10/a00350.html#a99cf85592e12bc32b930e594df346ef1">PICOTM_TM_STORE_TX()</a></code>. We can use these macros to define load and store functions for our application's data types. Both macros expand to inline C functions, so we don't loose performance compared to <code><a class="el" href="../../db/d10/a00350.html#a8b8b1aa8f2f6d9fbb46c4c3a7cf82cc5">load_tx()</a></code> and <code><a class="el" href="../../db/d10/a00350.html#ab3a4effe15e2519ed409cf6b243d57c5">store_tx()</a></code>.</p>
<div class="fragment"><div class="line"><span class="comment">// An application-specific type</span></div><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    my_int_type;</div><div class="line"></div><div class="line"><span class="comment">// Define load_my_int_type_tx()</span></div><div class="line"><a class="code" href="../../db/d10/a00350.html#a5efe8b5eade6b9a12c00ba9a39a48f91">PICOTM_TM_LOAD_TX</a>(my_int_type, my_int_type);</div><div class="line"></div><div class="line"><span class="comment">// Define store_my_int_type_tx()</span></div><div class="line"><a class="code" href="../../db/d10/a00350.html#a99cf85592e12bc32b930e594df346ef1">PICOTM_TM_STORE_TX</a>(my_int_type, my_int_type);</div></div><!-- fragment --><p>Since address and pointer handling can be tricky, there are also helpers for loading and storing pointers. These functions load and store the address stored in a pointer variable, but not the value stored at that address.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* x_ptr;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <span class="keywordtype">int</span>* x_ptr_tx = <a class="code" href="../../db/d10/a00350.html#ab4380a1a8d73b3b562757425e7ab9094">load_ptr_tx</a>(&amp;x_ptr);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_ptr&#39; is now stored in &#39;x_ptr_tx&#39;.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#a39ce6fb681ffc001e2346c3fb3f421d9">store_ptr_tx</a>(&amp;x_ptr, &amp;x_ptr_tx);</div><div class="line"></div><div class="line">    <span class="comment">// The value of &#39;x_ptr_tx&#39; will be committed into &#39;x_ptr&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Loads and stores always copy values into or out of a transaction. There are cases where we don't want a copy, but the exact memory location of a value. This is called <em>privatization.</em> For example, the function <code>memcpy()</code> loads and stores an indefinite amount of data between memory buffers. The actual buffer size is often not known in advance. It would be wasteful to first load the data into a transaction-local buffer and then further store it in another buffer.</p>
<p>The functions <code><a class="el" href="../../db/d10/a00350.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx()</a></code> and <code><a class="el" href="../../db/d10/a00350.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a></code> offer privatization of memory locations.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> x;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx</a>(&amp;x, <span class="keyword">sizeof</span>(x), <a class="code" href="../../db/d10/a00350.html#a99fb83031ce9923c84392b4e92f956b5ab2fc72e61777f33a35b73fbe4431bb41">PICOTM_TM_PRIVATIZE_LOAD</a>);</div><div class="line"></div><div class="line">    <span class="comment">// The memory location of &#39;x&#39; is now available within the transaction.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#a6d8e89acfc5f6f5d21689ecbc682a05f">privatize_tx</a>(&amp;x, <span class="keyword">sizeof</span>(x), <a class="code" href="../../db/d10/a00350.html#a99fb83031ce9923c84392b4e92f956b5a182a1cba2a7e3b183054a15dd36ded9f">PICOTM_TM_PRIVATIZE_STORE</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Changes to &#39;x&#39; will be committed into the memory location of &#39;x&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>This privatizes <code>x</code> for transactional access from within the transaction. The number of bytes is given in the second argument. The flags argument is a bitmask of <code>PICOTM_TM_PRIVATIZE_LOAD</code> and <code>PICOTM_TM_PRIVATIZE_STORE</code>. These flags control how picotm handles the memory location. If we only privatized a memory location for loading <em>or</em> storing, we may never invoke the other operation. Setting no flags at all will discard the memory location. This signals to other transactions that the memory is invalid and to be freed.</p>
<p>There can be cases where we don't know in advance how large in size the privatized buffer is going to be. For example, if we privatize a C string, the length is not explicitly stored in the string, but given by the location of the terminating <code>\0</code> character. To privatize a memory region up to and including a specific character, there is <code><a class="el" href="../../db/d10/a00350.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span>* str = <span class="stringliteral">&quot;foo&quot;</span>;</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx</a>(str, <span class="charliteral">&#39;\0&#39;</span>, <a class="code" href="../../db/d10/a00350.html#a99fb83031ce9923c84392b4e92f956b5ab2fc72e61777f33a35b73fbe4431bb41">PICOTM_TM_PRIVATIZE_LOAD</a>);</div><div class="line"></div><div class="line">    <span class="comment">// The string at &#39;str&#39; is now available within the transaction.</span></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx</a>(str, <span class="charliteral">&#39;\0&#39;</span>, <a class="code" href="../../db/d10/a00350.html#a99fb83031ce9923c84392b4e92f956b5a182a1cba2a7e3b183054a15dd36ded9f">PICOTM_TM_PRIVATIZE_STORE</a>);</div><div class="line"></div><div class="line">    <span class="comment">// Changes to &#39;str&#39; will be committed into the string at &#39;str&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>Using <code><a class="el" href="../../db/d10/a00350.html#aeace4eaf0dce3f56ec63a942c98192cf">privatize_c_tx()</a></code> with strings is the most common use case, but arbitrary characters are possible.</p>
<p>Finally, there is <code><a class="el" href="../../db/d10/a00350.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx()</a></code>. Even through the name suggests load-and-store, the function is a mixture of load, store and privatization. It privatizes an input buffer for loading and an output buffer for storing, and copies the input buffer's content into the output buffer.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ibuf[20];</div><div class="line"><span class="keywordtype">int</span> obuf[20];</div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc4de35068696187a89ba73ff54f2c82">picotm_begin</a></div><div class="line"></div><div class="line">    <a class="code" href="../../db/d10/a00350.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx</a>(ibuf, obuf, <span class="keyword">sizeof</span>(obuf));</div><div class="line"></div><div class="line">    <span class="comment">// The data in &#39;ibuf&#39; will be committed into the memory of &#39;obuf&#39;.</span></div><div class="line"></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#aa2a3ff1fd64dd3038cb3e863da12f1c9">picotm_commit</a></div><div class="line"><a class="code" href="../../d7/db6/a00940.html#acc10340471b96a797fbf6610341bbe01">picotm_end</a></div></div><!-- fragment --><p>A call to <code><a class="el" href="../../db/d10/a00350.html#ae73ef88a778eaac2c71eb5a4d5b0e8d9">loadstore_tx()</a></code> is like a call to <code>memcpy()</code> that privatizes its input buffers. It's an optimization for platform without transactional C library. </p>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<!--
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
-->
</body>
</html>
